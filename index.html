<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>萍宝 圣诞快乐</title>
<style>
body{
    margin:0;overflow:hidden;background:#000;
    display:flex;justify-content:center;align-items:center;height:100vh;
    font-family:'Helvetica Neue',Arial;
}
#canvas-wrapper{position:relative;width:100%;height:100%;overflow:hidden;}
#canvas-container{width:100%;height:100%;}
</style>

<script type="importmap">
{
  "imports":{
    "three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div id="canvas-wrapper">
  <div id="canvas-container"></div>
</div>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

/* ================= 原有变量 ================= */
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

let scene,camera,renderer,composer;
const mainGroup=new THREE.Group();
let snowSystem;
const dummy=new THREE.Object3D();

/* ================= 新增：流星系统 ================= */
let meteorSystem;
const meteors=[];
const METEOR_COUNT=6;

/* ================= 初始化 ================= */
initThree();
animate();

/* ================= Three 初始化 ================= */
function initThree(){
    const container=document.getElementById('canvas-container');
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x020205);

    const w=innerWidth,h=innerHeight;
    camera=new THREE.PerspectiveCamera(50,w/h,0.1,1000);
    camera.position.z=w<h?160:120;

    renderer=new THREE.WebGLRenderer({antialias:!isMobile});
    renderer.setSize(w,h);
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    container.appendChild(renderer.domElement);

    const pmrem=new THREE.PMREMGenerator(renderer);
    scene.environment=pmrem.fromScene(new RoomEnvironment(),0.04).texture;

    composer=new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene,camera));
    composer.addPass(new UnrealBloomPass(
        new THREE.Vector2(w,h),1.2,0.4,0.85
    ));

    createSnow();
    createMeteors();

    scene.add(mainGroup);
    window.addEventListener('resize',onResize);
}

/* ================= 雪花 ================= */
function createSnow(){
    const pos=[],vel=[];
    for(let i=0;i<2000;i++){
        pos.push((Math.random()-0.5)*200,Math.random()*100,(Math.random()-0.5)*200);
        vel.push((Math.random()-0.5)*0.3,-Math.random()*0.6-0.2,(Math.random()-0.5)*0.3);
    }
    const g=new THREE.BufferGeometry();
    g.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
    g.setAttribute('velocity',new THREE.Float32BufferAttribute(vel,3));
    snowSystem=new THREE.Points(
        g,
        new THREE.PointsMaterial({
            color:0xffffff,size:0.5,transparent:true,opacity:0.8
        })
    );
    scene.add(snowSystem);
}

/* ================= 流星（新增） ================= */
function createMeteors(){
    const pos=[];
    for(let i=0;i<METEOR_COUNT;i++){
        meteors.push({
            t:Math.random(),
            speed:0.0015+Math.random()*0.0015,
            startX:-150,
            endX:150,
            height:40+Math.random()*40,
            z:-120-Math.random()*80
        });
        pos.push(-150,60,meteors[i].z);
    }
    const g=new THREE.BufferGeometry();
    g.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
    meteorSystem=new THREE.Points(
        g,
        new THREE.PointsMaterial({
            color:0xffffff,
            size:1.2,
            transparent:true,
            opacity:0.9,
            blending:THREE.AdditiveBlending
        })
    );
    scene.add(meteorSystem);
}

/* ================= 动画 ================= */
function animate(){
    requestAnimationFrame(animate);

    // 雪花更新
    if(snowSystem){
        const p=snowSystem.geometry.attributes.position.array;
        const v=snowSystem.geometry.attributes.velocity.array;
        for(let i=0;i<2000;i++){
            p[i*3]+=v[i*3];
            p[i*3+1]+=v[i*3+1];
            p[i*3+2]+=v[i*3+2];
            if(p[i*3+1]<-60)p[i*3+1]=60;
        }
        snowSystem.geometry.attributes.position.needsUpdate=true;
    }

    // 流星更新（半圆轨迹）
    if(meteorSystem){
        const p=meteorSystem.geometry.attributes.position.array;
        meteors.forEach((m,i)=>{
            m.t+=m.speed;
            if(m.t>1)m.t=0;
            p[i*3]=THREE.MathUtils.lerp(m.startX,m.endX,m.t);
            p[i*3+1]=Math.sin(m.t*Math.PI)*m.height+20;
            p[i*3+2]=m.z;
        });
        meteorSystem.geometry.attributes.position.needsUpdate=true;
    }

    composer.render();
}

/* ================= resize ================= */
function onResize(){
    const w=innerWidth,h=innerHeight;
    camera.aspect=w/h;
    camera.updateProjectionMatrix();
    renderer.setSize(w,h);
    composer.setSize(w,h);
}
</script>
</body>
</html>
